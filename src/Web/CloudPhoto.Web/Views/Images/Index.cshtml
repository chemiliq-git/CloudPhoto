@using CloudPhoto.Web.ViewModels.Images
@using CloudPhoto.Common;
@model IEnumerable<ListImageViewModel>

@{
    ViewData["Title"] = "Index";

}

@{
    int imagePerPage = GlobalConstants.ImagePerPage;
}

<form id="keyForm" method="post"></form>

<div class="row container-fluid">
    <div id="side-search" class="col-md-2" style="display:none">
        @* Load filter bar *@
        @await Component.InvokeAsync("FilterBar")
    </div>
    <div id="hide-side-search" @*style="display:none"*@>
        <a href="#" onclick="onclickShowSearcBar()">
            <i class="fas fa-search"></i>
            Show search
        </a>
    </div>
    <div id="containerImages" class="col-md-12">
        <div id="partialView" class="row">
            <partial name="_ImageListPartial" model="@Model" data="@Model">
        </div>
    </div>
</div>

<div id="progress" class="text-center" style="display: none;">
    <div class="spinner-border a" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>

<div class="modal modal-full fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <div id="modalPartialView">
                    @*here must show _PreviewImagePartial*@
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script type="text/javascript" src="~/js/myFloatPaging.js"></script>
    <script>

            var searchData = new Object();
            searchData.pageSize = @imagePerPage;
            searchData.pageIndex = 0;
            searchData.selectCategory = [];
            searchData.searchText = "";

            var hasAnoutherPages = true;
            var hasStartRequest = false;

        var maxImageIndex;
        var currentSelectImage;
        var userVode;

            $(document).ready(
                function () {
                    hookToCloseSideMenu();
                    hookToClearAllFilter();
                    hookToArrowKey();

                    configPage();
                    var autoCompleateHelper = new myAutocompleteHelper();
                    autoCompleateHelper.configAutoCompleteTags(onStartAutoCompleteSearch, onStartAutoCompleteSearch);

                    RegisterFloatPaging(readSearchData, saveSearchData, '/images/GetSearchingData');
                    startSearchData();
                });

        function showModalImage(imageIndex) {
            currentSelectImage = imageIndex;
            $('#myModal').modal('show');
            GetPreviewImageData(currentSelectImage);
        }

        function hookToArrowKey() {
            document.addEventListener('keydown', function (e) {
                switch (e.keyCode) {
                    case 37:
                        navigationToLeft();
                        break;
                    case 39:
                        navigationToRigth();
                        break;
                }
            });
        }

        function navigationToLeft() {
            if (currentSelectImage > 1) {
                currentSelectImage = currentSelectImage - 1;
                GetPreviewImageData(currentSelectImage);
            }
        }

        function navigationToRigth() {
            if (!maxImageIndex
                || maxImageIndex - 1 >= currentSelectImage) {
                currentSelectImage = currentSelectImage + 1;
                GetPreviewImageData(currentSelectImage);
            }
        }

        function GetPreviewImageData(index) {
            var token = $("#keyForm input[name=__RequestVerificationToken]").val();
            var formData = new FormData();
            formData.append("id", index);
            $.ajax({
                url: '/images/PreviewImage',
                data: formData,
                processData: false,
                contentType: false,
                type: "POST",
                headers: { 'X-CSRF-TOKEN': token },
                xhrFields: {
                    withCredentials: true
                },
                success: function (data) {
                    var pageContainer = $('#modalPartialView');
                    if (data != ''
                        && pageContainer) {
                        pageContainer.html("");
                        pageContainer.append(data);
                    }
                    else {
                        currentSelectImage = currentSelectImage - 1;
                        maxImageIndex = currentSelectImage;
                    }
                },
                error: function () {
                    alert("Error while retrieving data!");
                }
            });
        }

            // execute when selected element on tag search control
            function onStartAutoCompleteSearch() {
                searchData = readSearchData();
                searchData.searchText = $('#searchImageTag').val();
                saveSearchData(searchData);
            }

            function readSearchData() {
                var txtSearchData = $.cookie("searchData");
                if (txtSearchData) {
                    var tempSearchData = JSON.parse(txtSearchData);
                    return tempSearchData;
                }
                else {
                    return searchData;
                }
            }

            function saveSearchData(searchData) {
                var txtSearchData = JSON.stringify(searchData);
                $.cookie("searchData", txtSearchData, { path: "/" });
            }

            function clearSearchData() {
                $.cookie("searchData", "", { path: "/" });
                searchData.selectCategory = [];
                searchData.searchText = "";
            }

            function checkUncheckCategory(checkBox) {
                searchData = readSearchData();

                if (checkBox.checked == true) {
                    searchData.selectCategory.push(checkBox.id);
                }
                else {
                    var filtered = searchData.selectCategory.filter(function (value, index, arr) {
                        return value != checkBox.id;
                    });
                    searchData.selectCategory = filtered;
                }
                saveSearchData(searchData);
                startSearchData();
            }

            function configPage() {
                var showSearchBar = $.cookie("show-search-bar");
                if (showSearchBar != null) {
                    toggleMenu();
                }

                searchData = readSearchData();

                showCheckedCategory(searchData.selectCategory);

                $('#searchImageTag').val(searchData.searchText);
            }

            function showCheckedCategory(arraySelectCategories) {
                arraySelectCategories.forEach(element =>
                    document.getElementById(element).checked = true);
            }

            function onclickShowSearcBar() {
                $.cookie("show-search-bar", "true", { path: "/Images" });
                toggleMenu();
            }

            function hookToCloseSideMenu() {
                const node = document.getElementById("sideCloseBtn");
                node.addEventListener("click", function (event) {
                    $.cookie("show-search-bar", "false", { path: "/Images" });
                    toggleMenu();
                });
            }

            function hookToClearAllFilter() {
                const node = document.getElementById("clearFilter");
                node.addEventListener("click", function (event) {
                    clearSearchData();
                    $('#groupCheckBox input:checked').each(function () {
                        this.checked = false;
                    });

                    $('#searchImageTag').val(null);

                    startSearchData();
                });
            }

            function toggleMenu() {
                var show = $.cookie("show-search-bar");
                var searchBox = document.getElementById("side-search");
                if (show === "true") {
                    searchBox.style.display = "block";
                } else {
                    searchBox.style.display = "none";
                }

                var hideSearchBox = document.getElementById("hide-side-search");
                if (show === "false") {
                    hideSearchBox.style.display = "block";
                } else {
                    hideSearchBox.style.display = "none";
                }

                var containerImage = document.getElementById("containerImages");
                if (show === "false") {
                    containerImage.classList.remove("col-md-10");
                    containerImage.classList.add("col-md-12")
                } else {
                    containerImage.classList.remove("col-md-12");
                    containerImage.classList.add("col-md-10")
                }

            }
    </script>
}
